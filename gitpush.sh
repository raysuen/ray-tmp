#!/bin/bash

<<<<<<< HEAD
# æ­¥éª¤1ï¼šåˆ é™¤å†—ä½™çš„.DS_Store/._*æ–‡ä»¶ï¼ˆæ’é™¤.gitç›®å½•ï¼‰
find . \( -name '.DS_Store' -o -name '._*' \) -not -path '*/.git/*' -delete

# æ­¥éª¤2ï¼šæš‚å­˜æ‰€æœ‰ä¿®æ”¹ï¼ˆåŒ…æ‹¬åˆšåˆ é™¤å†—ä½™æ–‡ä»¶åçš„å˜æ›´ï¼‰
git add .  # æ›¿æ¢git add *ï¼Œé¿å…æ¼æ£€éšè—æ–‡ä»¶/ç›®å½•

# æ­¥éª¤3ï¼šæäº¤æœ¬åœ°å˜æ›´ï¼ˆå¤‡æ³¨ä¸ºå½“æ—¥æ—¥æœŸï¼‰
git commit -m "`/Users/sunpeng/raysuen/bin/rdate.py -f "%Y%m%d"`" || true  
# åŠ || trueï¼šè‹¥æ²¡æœ‰å¯æäº¤çš„å˜æ›´ï¼ˆæ¯”å¦‚ä»…åˆ é™¤å†—ä½™æ–‡ä»¶æ— ä»£ç æ”¹åŠ¨ï¼‰ï¼Œè„šæœ¬ä¸ä¸­æ–­

# æ­¥éª¤4ï¼šä¸´æ—¶æš‚å­˜å·¥ä½œåŒºæœªæäº¤çš„ä¿®æ”¹ï¼ˆè§£å†³"unstaged changes"æŠ¥é”™ï¼‰
git stash push -m "temp_stash_before_pull" 2>/dev/null || true  

# æ­¥éª¤5ï¼šæ‹‰å–è¿œç¨‹masterå¹¶å˜åŸºï¼ˆæ˜¾å¼æŒ‡å®šç­–ç•¥ï¼Œè§£å†³åˆ†æ”¯åˆ†æ­§ï¼‰
git pull --rebase origin master

# æ­¥éª¤6ï¼šæ¢å¤ä¸´æ—¶æš‚å­˜çš„ä¿®æ”¹
git stash pop 2>/dev/null || true  

# æ­¥éª¤7ï¼šæ¨é€æœ¬åœ°masteråˆ°è¿œç¨‹
git push -u origin master
=======
set -euo pipefail  # ä¸¥æ ¼æ¨¡å¼ï¼šå‘½ä»¤å¤±è´¥ç«‹å³é€€å‡º

# æ ‡è®°æ˜¯å¦æœ‰stashå†…å®¹
has_stashed=0

# ===================== ç¬¬ä¸€æ­¥ï¼šå…ˆæ¸…ç†æ— ç”¨æ–‡ä»¶ï¼ˆé¿å…æš‚å­˜è¿™äº›æ–‡ä»¶ï¼‰ =====================
echo "ğŸ§¹ æå‰æ¸…ç†.DS_Store/._*æ–‡ä»¶ï¼ˆæ’é™¤.gitç›®å½•ï¼‰..."
find . \( -name '.DS_Store' -o -name '._*' \) -not -path '*/.git/*' -delete 2>/dev/null
echo "âœ… æ— ç”¨æ–‡ä»¶æå‰æ¸…ç†å®Œæˆã€‚"

# ===================== å¢å¼ºç‰ˆï¼šæ£€æµ‹æ‰€æœ‰æœªå¤„ç†çš„ä¿®æ”¹ï¼ˆå«æœªè¿½è¸ªæ–‡ä»¶ï¼‰ =====================
echo "ğŸ” æ£€æµ‹æœ¬åœ°æ‰€æœ‰æœªæäº¤/æœªè¿½è¸ªçš„ä¿®æ”¹..."
# æ£€æŸ¥æ˜¯å¦æœ‰ï¼šå·²è¿½è¸ªæ–‡ä»¶çš„ä¿®æ”¹ï¼ˆæš‚å­˜/æœªæš‚å­˜ï¼‰ + æœªè¿½è¸ªçš„æ–°æ–‡ä»¶
if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
    echo "â„¹ï¸  æ£€æµ‹åˆ°æœ¬åœ°æœ‰æœªå¤„ç†çš„ä¿®æ”¹/æœªè¿½è¸ªæ–‡ä»¶ï¼Œå¼€å§‹æš‚å­˜ï¼ˆåŒ…å«æœªè¿½è¸ªæ–‡ä»¶ï¼‰..."
    # -uï¼šstashåŒ…å«æœªè¿½è¸ªæ–‡ä»¶ï¼›-aï¼šè¿˜åŒ…å«è¢«å¿½ç•¥çš„æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œæ ¹æ®éœ€æ±‚ï¼‰
    git stash push -u -m "auto-stash-$(date +%Y%m%d%H%M%S)"
    has_stashed=1
    echo "âœ… æœ¬åœ°æ‰€æœ‰ä¿®æ”¹ï¼ˆå«æœªè¿½è¸ªæ–‡ä»¶ï¼‰å·²æš‚å­˜ã€‚"
else
    echo "âœ… æœ¬åœ°æ— æœªå¤„ç†çš„ä¿®æ”¹ï¼Œæ— éœ€æš‚å­˜ã€‚"
fi

# ===================== æ‹‰å–è¿œç¨‹ä»£ç ï¼ˆå¤±è´¥åˆ™æ¢å¤stashå¹¶é€€å‡ºï¼‰ =====================
echo "ğŸ”„ æ‹‰å–è¿œç¨‹masteråˆ†æ”¯æœ€æ–°å†…å®¹..."
if ! git pull --rebase origin master; then
    echo "âŒ æ‹‰å–è¿œç¨‹ä»£ç å¤±è´¥ï¼è¯·æ£€æŸ¥å†²çª/ç½‘ç»œ/æƒé™åé‡è¯•ã€‚"
    # æ¢å¤stashï¼ˆè‹¥æœ‰ï¼‰
    if [ $has_stashed -eq 1 ]; then
        echo "ğŸ”™ æ¢å¤ä¹‹å‰æš‚å­˜çš„æœ¬åœ°ä¿®æ”¹..."
        git stash pop || echo "âš ï¸  æš‚å­˜å†…å®¹æ— åŒ¹é…é¡¹ï¼Œå¯å¿½ç•¥ã€‚"
    fi
    exit 1
fi
echo "âœ… è¿œç¨‹ä»£ç æ‹‰å–å®Œæˆã€‚"

# ===================== æ¢å¤æš‚å­˜çš„ä¿®æ”¹ï¼ˆå«æœªè¿½è¸ªæ–‡ä»¶ï¼Œä¼˜åŒ–å†²çªå¤„ç†ï¼‰ =====================
if [ $has_stashed -eq 1 ]; then
    echo "ğŸ”™ æ¢å¤æœ¬åœ°æš‚å­˜çš„ä¿®æ”¹ï¼ˆå«æœªè¿½è¸ªæ–‡ä»¶ï¼‰..."
    # å…ˆå°è¯•æ™®é€špopï¼Œè‹¥å¤±è´¥åˆ™å¼ºåˆ¶æ¢å¤ï¼ˆè¦†ç›–å·²å­˜åœ¨çš„æœªè¿½è¸ªæ–‡ä»¶ï¼‰
    if ! git stash pop; then
        echo "âš ï¸  å¸¸è§„æ¢å¤å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ¢å¤ï¼ˆè¦†ç›–é‡å¤çš„æœªè¿½è¸ªæ–‡ä»¶ï¼‰..."
        # æ‰‹åŠ¨åº”ç”¨stashçš„ä¿®æ”¹ï¼Œå¿½ç•¥æœªè¿½è¸ªæ–‡ä»¶çš„é‡å¤
        git stash apply --index || {
            echo "âŒ å¼ºåˆ¶æ¢å¤ä¹Ÿå¤±è´¥ï¼è¯·æ‰‹åŠ¨æ‰§è¡Œ git stash apply è§£å†³å†²çªï¼Œå†åˆ é™¤stashï¼ˆgit stash dropï¼‰"
            exit 1
        }
        # æ¢å¤ååˆ é™¤è¯¥stashï¼ˆé¿å…æ®‹ç•™ï¼‰
        git stash drop
        echo "âœ… æœ¬åœ°ä¿®æ”¹å·²å¼ºåˆ¶æ¢å¤ï¼ˆè¦†ç›–é‡å¤æ–‡ä»¶ï¼‰ã€‚"
    else
        echo "âœ… æœ¬åœ°ä¿®æ”¹å·²æ¢å¤ã€‚"
    fi
fi

# ===================== æäº¤æ¨é€ =====================
echo "ğŸ“¤ æäº¤å¹¶æ¨é€æœ¬åœ°å†…å®¹..."
git add .  # æ·»åŠ æ‰€æœ‰ä¿®æ”¹ï¼ˆå«éšè—æ–‡ä»¶ï¼Œå¿½ç•¥.gitignoreï¼‰
# æ— ä¿®æ”¹åˆ™è·³è¿‡commit
git commit -m "$(/Users/sunpeng/raysuen/bin/rdate.py -f "%Y%m%d")" || {
    echo "â„¹ï¸  æ— éœ€è¦æäº¤çš„ä¿®æ”¹ï¼Œè·³è¿‡commitã€‚"
}
git push -u origin master
echo "âœ… å†…å®¹å·²æ¨é€åˆ°è¿œç¨‹masteråˆ†æ”¯ï¼"

echo "ğŸ‰ åŒæ­¥æµç¨‹å®Œæˆï¼"
>>>>>>> c2ada33
